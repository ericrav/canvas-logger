<html style="height: 100%; overflow: hidden;">
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
  <link rel="stylesheet" href="uikit/css/uikit.min.css" />
  <script src="uikit/js/uikit.min.js"></script>
  <script src="https://cdn.firebase.com/js/client/2.4.1/firebase.js"></script>

  <meta name="viewport" content="initial-scale=1, maximum-scale=1">

  <title>Canvas Logger</title>
</head>
<body style="height: 100%; overflow: hidden;">
  <nav class="uk-navbar">
    <ul class="uk-navbar-nav">
      <li><h1 style="margin-left: 5px; margin-right: 20px; margin-top: 5px; margin-bottom: 5px;">Canvas Logger</h1></li>
      <li><button id="record-button" class="uk-button-success uk-button-large" style="margin-top: 5px; margin-bottom: 5px;">Start</button></li>
    </ul>
  </nav>
  <div id="canvas" style="overflow: hidden;"></div>

  <script type="text/javascript">
  $(document).ready(function() {
    // === canvas stuff
    // most of this came from http://www.williammalone.com/articles/create-html5-canvas-javascript-drawing-app/#demo-simple
    var canvasDiv = document.getElementById('canvas');
    canvas = document.createElement('canvas');
    canvas.setAttribute('width', window.innerWidth-10);
    canvas.setAttribute('height', window.innerHeight-20-$('uk-navbar').height());
    canvas.setAttribute('id', 'canvas');
    canvasDiv.appendChild(canvas);
    if(typeof G_vmlCanvasManager != 'undefined') {
      canvas = G_vmlCanvasManager.initElement(canvas);
    }
    context = canvas.getContext("2d");

    var clickX;
    var clickY;
    var clickDrag;
    var clickTimes;
    var paint;
    function clear() {
      clickX = new Array();
      clickY = new Array();
      clickDrag = new Array();
      clickTimes = new Array();
      
      redraw();
    }

    clear();

    var startTime;
    function addClick(x, y, dragging) {
      clickX.push(x);
      clickY.push(y);
      clickDrag.push(dragging);
      clickTimes.push(new Date().getTime()-startTime);
    }

    function redraw() {
      context.clearRect(0, 0, context.canvas.width, context.canvas.height); // Clears the canvas
      
      context.strokeStyle = "#df4b26";
      context.lineJoin = "round";
      context.lineWidth = 5;
          
      for(var i=0; i < clickX.length; i++) {
        context.beginPath();
        if(clickDrag[i] && i) {
          context.moveTo(clickX[i-1], clickY[i-1]);
         }
         else {
           context.moveTo(clickX[i]-1, clickY[i]);
         }
         context.lineTo(clickX[i], clickY[i]);
         context.closePath();
         context.stroke();
      }
    }

    $('#canvas').on('mousedown touchstart', function(e) {
      var eventX;
      var eventY;
      if(e.type == 'touchstart') {
        eventX = e.originalEvent.touches[0].pageX;
        eventY = e.originalEvent.touches[0].pageY;
      }
      else {
        eventX = e.pageX;
        eventY = e.pageY;
      }

      paint = true;
      addClick(eventX - this.offsetLeft, eventY - this.offsetTop, false);
      redraw();
    });

    $('#canvas').on('mousemove touchmove', function(e) {
      var eventX;
      var eventY;
      if(e.type == 'touchmove') {
        eventX = e.originalEvent.touches[0].pageX;
        eventY = e.originalEvent.touches[0].pageY;
      }
      else {
        eventX = e.pageX;
        eventY = e.pageY;
      }

      if(paint){
        addClick(eventX - this.offsetLeft, eventY - this.offsetTop, true);
        redraw();
      }
    });

    $('#canvas').on('mouseup mouseleave touchend touchcancel', function(e) {
      paint = false;
    });

    // === button stuff
    var firebaseState = new Firebase("https://digiwrite.firebaseio.com/state");
    var firebaseData = new Firebase("https://digiwrite.firebaseio.com/data");
    $('#record-button').click(function() {
      if($('#record-button').text() == 'Start') {
        firebaseState.set('on');

        $('#record-button').text('Stop');
        $('#record-button').removeClass('uk-button-success');
        $('#record-button').addClass('uk-button-danger');
        clear();

        startTime = new Date().getTime();
      }
      else {
        firebaseState.set('off');

        $('#record-button').text('Start');
        $('#record-button').removeClass('uk-button-danger');
        $('#record-button').addClass('uk-button-success');

        // prompt for session ID
        UIkit.modal.prompt("Session ID:", '', function(name){
          var data = {};
          for(var i = 0; i < clickX.length; i++) {
            var line = {};
            line['x'] = clickX[i];
            line['y'] = clickY[i];
            data[clickTimes[i]] = line;
          }
          var label = new Date().getTime() + '-' + name;
          firebaseData.child(label).set(data);
          var url = firebaseData + '/' + label + '.json';
          UIkit.modal.alert('Written to: <a href="' + url + '">' + url + '</a>');

          clear();
        });
      }
    });
  });
  </script>
</body>
</html>