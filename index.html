<html>
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
  <link rel="stylesheet" href="uikit/css/uikit.min.css" />
  <script src="uikit/js/uikit.min.js"></script>
</head>
<body>
  <nav class="uk-navbar">
    <div class="uk-navbar-content">Canvas Logger</div>
    <div class="uk-navbar-content"><button id="record-button" class="uk-button-danger uk-button-large">Save</button></div>
  </nav>
  <div id="canvas" style="overflow: hidden;"></div>

  <script type="text/javascript">
  $(document).ready(function() {
    // === canvas stuff
    // most of this came from http://www.williammalone.com/articles/create-html5-canvas-javascript-drawing-app/#demo-simple
    var canvasDiv = document.getElementById('canvas');
    canvas = document.createElement('canvas');
    canvas.setAttribute('width', window.innerWidth-10);
    canvas.setAttribute('height', window.innerHeight-20-$('uk-navbar').height());
    canvas.setAttribute('id', 'canvas');
    canvasDiv.appendChild(canvas);
    if(typeof G_vmlCanvasManager != 'undefined') {
      canvas = G_vmlCanvasManager.initElement(canvas);
    }
    context = canvas.getContext("2d");

    var clickX;
    var clickY;
    var clickDrag;
    var clickTimes;
    var paint;
    function clear() {
      clickX = new Array();
      clickY = new Array();
      clickDrag = new Array();
      clickTimes = new Array();
      
      redraw();
    }

    clear();

    function addClick(x, y, dragging) {
      clickX.push(x);
      clickY.push(y);
      clickDrag.push(dragging);
      clickTimes.push(new Date().getTime());
    }

    function redraw() {
      context.clearRect(0, 0, context.canvas.width, context.canvas.height); // Clears the canvas
      
      context.strokeStyle = "#df4b26";
      context.lineJoin = "round";
      context.lineWidth = 5;
          
      for(var i=0; i < clickX.length; i++) {
        context.beginPath();
        if(clickDrag[i] && i) {
          context.moveTo(clickX[i-1], clickY[i-1]);
         }
         else {
           context.moveTo(clickX[i]-1, clickY[i]);
         }
         context.lineTo(clickX[i], clickY[i]);
         context.closePath();
         context.stroke();
      }
    }

    $('#canvas').mousedown(function(e) {
      var mouseX = e.pageX - this.offsetLeft;
      var mouseY = e.pageY - this.offsetTop;

      paint = true;
      addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop);
      redraw();
    });

    $('#canvas').mousemove(function(e) {
      if(paint){
        addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop, true);
        redraw();
      }
    });

    $('#canvas').mouseup(function(e) {
      paint = false;
    });

    $('#canvas').mouseleave(function(e) {
      paint = false;
    });

    // === button stuff
    var publicKey = 'n1mannrNXET6NM00Zzqj';
    var privateKey = 'MoV2mmgJnrcjoqAA9eY2'; // we're not doing anything top secret here anyways
    $('#record-button').click(function() {
      // prompt for session ID
      UIkit.modal.prompt("Session ID:", '', function(name){
        var logType = 'LOG'; // data types can be LOG or NEW
        var newType = 'NEW';
        var endType = 'END';
        var empty = '';

        // send a segmenting packet
        $.get('http://data.sparkfun.com/input/' + publicKey + '?private_key=' + privateKey + '&datatype=' + newType + '&id=' + name + '&time=' + empty + '&x= ' + empty + '&y=' + empty);

        // send data
        for(var i = 0; i < clickX.length; i++) {
          console.log('sending ' + i);
          $.get('http://data.sparkfun.com/input/' + publicKey + '?private_key=' + privateKey + '&datatype=' + logType + '&id=' + empty + '&time=' + clickTimes[i] + '&x= ' + clickX[i] + '&y=' + clickY[i]);
          console.log('done with ' + i);
        }

        $.get('http://data.sparkfun.com/input/' + publicKey + '?private_key=' + privateKey + '&datatype=' + endType + '&id=' + name + '&time=' + empty + '&x= ' + empty + '&y=' + empty);

        clear();
      });
    });
  });
  </script>
</body>
</html>